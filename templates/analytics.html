{% extends "base.html" %}

{% block title %}Analytics â€“ LendifyMe{% endblock %}

{% block extra_css %}
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
}
h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}
.subtitle {
    color: #6c757d;
    margin-bottom: 2rem;
}
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.metric-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.metric-label {
    color: #6c757d;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}
.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #212529;
}
.metric-subtext {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}
.section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}
.section h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    color: #212529;
}
.event-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.event-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.event-item:last-child {
    border-bottom: none;
}
.event-name {
    font-weight: 600;
    color: #212529;
}
.event-user {
    color: #6c757d;
    font-size: 0.85rem;
}
.event-time {
    color: #6c757d;
    font-size: 0.85rem;
}
.funnel {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
}
.funnel-step {
    flex: 1;
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
}
.funnel-step.success {
    background: #d4edda;
}
.funnel-arrow {
    font-size: 1.5rem;
    color: #6c757d;
}
.event-counts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}
.event-count-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-radius: 6px;
}
.badge {
    background: #667eea;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>ðŸ“Š Analytics Dashboard</h1>
    <p class="subtitle">Usage metrics and insights</p>

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Users</div>
            <div class="metric-value">{{ metrics.total_users }}</div>
            <div class="metric-subtext">
                +{{ metrics.new_users_7d }} this week
                <br>
                +{{ metrics.new_users_30d }} this month
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Daily Active Users</div>
            <div class="metric-value">{{ metrics.dau }}</div>
            <div class="metric-subtext">Users active today</div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Weekly Active Users</div>
            <div class="metric-value">{{ metrics.wau }}</div>
            <div class="metric-subtext">Users active in last 7 days</div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Monthly Active Users</div>
            <div class="metric-value">{{ metrics.mau }}</div>
            <div class="metric-subtext">Users active in last 30 days</div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Total Loans</div>
            <div class="metric-value">{{ metrics.total_loans }}</div>
            <div class="metric-subtext">
                +{{ metrics.loans_7d }} this week
                <br>
                +{{ metrics.loans_30d }} this month
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Week-over-Week Retention</div>
            <div class="metric-value">{{ '%.1f'|format(metrics.retention_rate) }}%</div>
            <div class="metric-subtext">Users returning from previous week</div>
        </div>
    </div>

    <!-- Bank Link Funnel -->
    <div class="section">
        <h2>Bank Connection Funnel (Last 30 Days)</h2>
        <div class="funnel">
            <div class="funnel-step">
                <div style="font-size: 1.5rem; font-weight: bold;">{{ metrics.bank_link_started }}</div>
                <div style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem;">Started</div>
            </div>
            <div class="funnel-arrow">â†’</div>
            <div class="funnel-step success">
                <div style="font-size: 1.5rem; font-weight: bold; color: #198754;">{{ metrics.bank_link_success }}</div>
                <div style="color: #198754; font-size: 0.85rem; margin-top: 0.25rem;">Connected</div>
            </div>
            <div class="funnel-arrow">â†’</div>
            <div class="funnel-step">
                <div style="font-size: 1.5rem; font-weight: bold;">{{ '%.1f'|format(metrics.bank_link_conversion) }}%</div>
                <div style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem;">Conversion Rate</div>
            </div>
        </div>
    </div>

    <!-- Event Counts -->
    <div class="section">
        <h2>Event Activity (Last 30 Days)</h2>
        <div class="event-counts">
            {% for event_name, count in event_counts %}
                <div class="event-count-item">
                    <span>{{ event_name }}</span>
                    <span class="badge">{{ count }}</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Events -->
    <div class="section">
        <h2>Recent Activity</h2>
        <ul class="event-list">
            {% for event in recent_events %}
                <li class="event-item">
                    <div>
                        <div class="event-name">{{ event.event_name }}</div>
                        <div class="event-user">{{ event.user_email }}</div>
                    </div>
                    <div class="event-time" data-timestamp="{{ event.created_at }}"></div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Update relative times every minute
setInterval(window.convertTimestamps, 60000);
{% endblock %}
