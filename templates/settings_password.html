{% extends "base.html" %}

{% block title %}Password Settings ‚Äì LendifyMe{% endblock %}

{% block extra_css %}
.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}
.settings-header h1 {
    margin: 0;
}
.back-link {
    display: inline-block;
    margin-bottom: 1rem;
    color: #007bff;
    text-decoration: none;
}
.back-link:hover {
    text-decoration: underline;
}
.settings-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 2rem;
    max-width: 600px;
}
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 0.5rem;
}
.status-badge.active {
    background: #d4edda;
    color: #155724;
}
.status-badge.inactive {
    background: #f8d7da;
    color: #721c24;
}
.status-badge.none {
    background: #e7f3ff;
    color: #004085;
}
form {
    margin-top: 1.5rem;
}
.form-group {
    margin-bottom: 1.5rem;
}
label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}
input[type="password"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}
input[type="password"]:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}
.helper-text {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
}
.btn-primary {
    background: #007bff;
    color: white;
}
.btn-primary:hover {
    background: #0056b3;
}
.btn-danger {
    background: #dc3545;
    color: white;
}
.btn-danger:hover {
    background: #c82333;
}
.info-box {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
}
.info-box h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: #333;
}
.info-box p {
    margin: 0;
    font-size: 0.9rem;
    color: #666;
}
.section-divider {
    border-top: 1px solid #e9ecef;
    margin: 2rem 0;
}
/* Password Strength Meter */
.password-strength {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
}
.strength-meter {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}
.strength-meter-fill {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
    border-radius: 2px;
}
.strength-meter-fill.weak {
    width: 33%;
    background: #dc3545;
}
.strength-meter-fill.fair {
    width: 66%;
    background: #ffc107;
}
.strength-meter-fill.strong {
    width: 100%;
    background: #28a745;
}
.strength-text {
    font-size: 0.85rem;
    font-weight: 600;
}
.strength-text.weak {
    color: #dc3545;
}
.strength-text.fair {
    color: #856404;
}
.strength-text.strong {
    color: #28a745;
}
.password-tips {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
    padding-left: 1rem;
}
.password-tips li {
    margin-bottom: 0.25rem;
}
.weak-password-warning {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 4px;
    display: none;
}
.weak-password-warning.show {
    display: block;
}
.weak-password-warning h4 {
    margin: 0 0 0.5rem 0;
    color: #856404;
    font-size: 0.95rem;
}
.weak-password-warning p {
    margin: 0;
    color: #856404;
    font-size: 0.85rem;
}
{% endblock %}

{% block content %}
<a href="/" class="back-link">‚Üê Back to Dashboard</a>

<div class="settings-header">
    <h1>Password Settings</h1>
</div>

<div class="settings-card">
    {% if redirect_from == 'banks' and not has_password %}
    <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
        <h3 style="color: #856404;">üîê Password Required for Bank Sync</h3>
        <p style="color: #856404;">
            For security, your bank credentials are encrypted with YOUR password - we never have access to them.
            This zero-knowledge encryption ensures even server admins can't access your bank accounts.
            Set up a password below to continue.
        </p>
    </div>
    {% endif %}

    <div class="info-box">
        <h3>
            Current Status:
            {% if has_password %}
                <span class="status-badge active">Password Enabled</span>
            {% else %}
                <span class="status-badge none">No Password Set</span>
            {% endif %}
        </h3>
        <p>
            {% if has_password %}
                Your password secures your loan data with zero-knowledge encryption. You can sign in using your password or request a magic link.
            {% else %}
                A password is required to encrypt your loan data. Without it, you won't be able to create or view loans.
            {% endif %}
        </p>
    </div>

    {% if needs_upgrade %}
        {# User has password but needs encryption salt for bank connections #}
        {% if redirect_from == 'banks' %}
        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1.5rem;">
            <h3 style="color: #856404;">üîê Account Upgrade Required for Bank Sync</h3>
            <p style="color: #856404;">
                To enable secure bank connections, please re-enter your password. This one-time upgrade sets up zero-knowledge encryption,
                ensuring your bank credentials are encrypted with YOUR password - we never have access to them.
            </p>
        </div>
        {% else %}
        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1.5rem;">
            <h3 style="color: #856404;">üîê Account Upgrade Available</h3>
            <p style="color: #856404;">
                Upgrade to zero-knowledge encryption to enable secure bank connections.
                Re-enter your password to complete this one-time security enhancement.
            </p>
        </div>
        {% endif %}

        <h2>Upgrade Account Security</h2>
        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="upgrade">

            <div class="form-group">
                <label for="new_password">Your Current Password</label>
                <input type="password" id="new_password" name="new_password" required>
                <p class="helper-text">Enter your password to enable bank encryption</p>
            </div>

            <button type="submit" class="btn btn-primary">Upgrade Account</button>
        </form>

    {% elif not has_password %}
        {# User doesn't have a password - show "Add Password" form #}
        <h2>Set Up Password</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">
            Your password encrypts all loan data with zero-knowledge encryption, ensuring complete privacy. This is required to use LendifyMe.
        </p>

        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add">

            <!-- Email field for password managers -->
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ session.user_email }}" readonly autocomplete="username"
                       style="background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                <p class="helper-text">This is your account email</p>
            </div>

            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" name="new_password" required autocomplete="new-password" oninput="checkPasswordStrength('new_password', 'add')">
                <div class="password-strength">
                    <div class="strength-meter">
                        <div class="strength-meter-fill" id="strength-fill-add"></div>
                    </div>
                    <div class="strength-text" id="strength-text-add"></div>
                </div>
                <p class="helper-text">At least 8 characters. <a href="https://bitwarden.com" target="_blank" rel="noopener">Use a password manager</a> for best security.</p>
            </div>

            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                <input type="password" id="confirm_password" name="confirm_password" autocomplete="new-password" required>
            </div>

            <div class="weak-password-warning" id="weak-warning-add">
                <h4>‚ö†Ô∏è Weak Password Detected</h4>
                <p>Your password is weak and may be easy to guess. We strongly recommend choosing a stronger password. Continue anyway?</p>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-add">Set Up Password</button>
        </form>

    {% else %}
        {# User has a password - show "Change Password" or "Reset Password" form #}
        {% if logged_in_via_recovery %}
        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1.5rem;">
            <h3 style="color: #856404;">üîê Reset Your Password</h3>
            <p style="color: #856404;">
                You logged in with a recovery code, so you can reset your password without knowing the old one.
                Choose a new password below to regain full access to your encrypted loan data.
            </p>
        </div>

        <h2>Reset Password</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">
            Create a new password for your account.
        </p>

        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="change">

            <!-- Email field for password managers -->
            <div class="form-group">
                <label for="email_reset">Email</label>
                <input type="email" id="email_reset" name="email" value="{{ session.user_email }}" readonly autocomplete="username"
                       style="background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
            </div>
        {% else %}
        <h2>Change Password</h2>
        <p style="color: #666; margin-bottom: 1.5rem;">
            Update your password to maintain secure access to your encrypted loan data.
        </p>

        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="change">

            <!-- Email field for password managers -->
            <div class="form-group">
                <label for="email_change">Email</label>
                <input type="email" id="email_change" name="email" value="{{ session.user_email }}" readonly autocomplete="username"
                       style="background: #f8f9fa; color: #6c757d; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label for="current_password">Current Password</label>
                <input type="password" id="current_password" name="current_password" autocomplete="current-password" required>
            </div>
        {% endif %}

            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password_change" name="new_password" autocomplete="new-password" required oninput="checkPasswordStrength('new_password_change', 'change')">
                <div class="password-strength">
                    <div class="strength-meter">
                        <div class="strength-meter-fill" id="strength-fill-change"></div>
                    </div>
                    <div class="strength-text" id="strength-text-change"></div>
                </div>
                <p class="helper-text">At least 8 characters. <a href="https://bitwarden.com" target="_blank" rel="noopener">Use a password manager</a> for best security.</p>
            </div>

            <div class="form-group">
                <label for="confirm_password">Confirm New Password</label>
                <input type="password" id="confirm_password_change" name="confirm_password" autocomplete="new-password" required>
            </div>

            <div class="weak-password-warning" id="weak-warning-change">
                <h4>‚ö†Ô∏è Weak Password Detected</h4>
                <p>Your password is weak and may be easy to guess. We strongly recommend choosing a stronger password. Continue anyway?</p>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-change">
                {% if logged_in_via_recovery %}Reset Password{% else %}Change Password{% endif %}
            </button>
        </form>

        <div class="section-divider"></div>

        <h2>üîÑ Regenerate Recovery Phrase</h2>
        <p style="color: #666; margin-bottom: 1rem;">
            If your recovery phrase has been compromised or you want to rotate it for security, you can generate a new one.
            <strong>This will invalidate your old recovery phrase.</strong>
        </p>

        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-bottom: 1.5rem;">
            <h3 style="color: #856404;">‚ö†Ô∏è Important: Save Your New Phrase</h3>
            <p style="color: #856404;">
                After regenerating, you'll be shown your new 6-word recovery phrase <strong>only once</strong>.
                Your old phrase will no longer work, so make sure to save the new one securely.
            </p>
        </div>

        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="regenerate_recovery">

            <div class="form-group">
                <label for="current_password_recovery">Current Password</label>
                <input type="password" id="current_password_recovery" name="current_password" required>
                <p class="helper-text">Enter your password to verify your identity</p>
            </div>

            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to regenerate your recovery phrase? Your old phrase will no longer work.');">
                üîÑ Generate New Recovery Phrase
            </button>
        </form>

        <div class="section-divider"></div>

        <div class="info-box" style="background: #f8f9fa; border-left-color: #6c757d;">
            <h3>üîí Why You Can't Remove Your Password</h3>
            <p>
                Your password is essential for encrypting and decrypting your loan data. Removing it would lock you out of your own data.
                If you forget your password, use the recovery phrase saved during registration.
            </p>
        </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
// Common passwords blocklist (top 100 most common)
const COMMON_PASSWORDS = [
    'password', '12345678', '123456789', '12345', '1234567', '123456',
    'password1', 'password123', 'qwerty', 'abc123', 'monkey', '1234567890',
    'letmein', 'trustno1', 'dragon', 'baseball', 'iloveyou', 'master',
    'sunshine', 'ashley', 'bailey', 'shadow', 'superman', 'qazwsx',
    '123123', 'welcome', 'admin', 'login', 'passw0rd', 'starwars',
    'whatever', 'freedom', 'mustang', 'batman', 'football', 'princess',
    'michael', 'jennifer', 'jordan', 'passw0rd', '111111', '000000',
    '696969', '666666', 'zxcvbnm', 'hunter', 'buster', 'soccer',
    'harley', 'ranger', 'hunter', 'charlie', 'abcd1234', 'password!',
    'qwertyuiop', 'asdfghjkl', 'zxcvbn', '1q2w3e4r', 'abcdef'
];

function checkPasswordStrength(inputId, formType) {
    const password = document.getElementById(inputId).value;
    const fillEl = document.getElementById('strength-fill-' + formType);
    const textEl = document.getElementById('strength-text-' + formType);
    const warningEl = document.getElementById('weak-warning-' + formType);
    const submitBtn = document.getElementById('submit-' + formType);

    if (password.length === 0) {
        fillEl.className = 'strength-meter-fill';
        textEl.textContent = '';
        textEl.className = 'strength-text';
        warningEl.classList.remove('show');
        return;
    }

    // Calculate strength score
    let score = 0;

    // Length scoring
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    if (password.length >= 16) score += 1;

    // Character variety scoring
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^a-zA-Z0-9]/.test(password)) score += 1;

    // Check if password is in common passwords list
    const isCommon = COMMON_PASSWORDS.includes(password.toLowerCase());

    if (isCommon) {
        score = 0; // Force weak if common password
    }

    // Determine strength level
    let strength = 'weak';
    let strengthText = 'Weak';

    if (isCommon) {
        strengthText = 'Too Common - Choose a different password';
    } else if (score >= 6) {
        strength = 'strong';
        strengthText = 'Strong';
    } else if (score >= 4) {
        strength = 'fair';
        strengthText = 'Fair';
    } else {
        strengthText = 'Weak';
    }

    // Update UI
    fillEl.className = 'strength-meter-fill ' + strength;
    textEl.textContent = strengthText;
    textEl.className = 'strength-text ' + strength;

    // Show warning for weak passwords
    if (strength === 'weak') {
        warningEl.classList.add('show');
    } else {
        warningEl.classList.remove('show');
    }
}

// Block common passwords on form submit
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const passwordField = form.querySelector('input[name="new_password"]');
            if (passwordField) {
                const password = passwordField.value;

                // Block common passwords
                if (COMMON_PASSWORDS.includes(password.toLowerCase())) {
                    e.preventDefault();
                    alert('This password is too common and frequently compromised. Please choose a different password.');
                    return false;
                }

                // Warn for weak passwords (but allow)
                const score = calculateScore(password);
                if (score < 4 && !confirm('Your password is weak. Are you sure you want to continue?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    });
});

function calculateScore(password) {
    let score = 0;
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    if (password.length >= 16) score += 1;
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^a-zA-Z0-9]/.test(password)) score += 1;
    return score;
}
</script>
{% endblock %}
{% endblock %}
