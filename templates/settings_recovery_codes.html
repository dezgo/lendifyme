{% extends "base.html" %}

{% block title %}Recovery Codes ‚Äì LendifyMe{% endblock %}

{% block extra_css %}
.back-link {
    display: inline-block;
    margin-bottom: 1rem;
    color: #007bff;
    text-decoration: none;
}
.back-link:hover {
    text-decoration: underline;
}
.settings-header {
    margin-bottom: 2rem;
}
.settings-header h1 {
    margin: 0 0 0.5rem 0;
}
.settings-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 2rem;
    max-width: 700px;
}
.info-box {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
}
.info-box.warning {
    background: #fff3cd;
    border-left-color: #ffc107;
}
.info-box h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: #333;
}
.info-box p {
    margin: 0;
    font-size: 0.9rem;
    color: #666;
}
.info-box ul {
    margin: 0.5rem 0 0 1.25rem;
    padding: 0;
}
.info-box li {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
}
.recovery-codes-display {
    background: #f8f9fa;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}
.recovery-codes-display h3 {
    margin: 0 0 1rem 0;
    color: #007bff;
}
.codes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
}
.code-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    text-align: center;
    font-weight: 600;
    color: #333;
}
.code-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
}
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
}
.btn-primary {
    background: #007bff;
    color: white;
}
.btn-primary:hover {
    background: #0056b3;
}
.btn-secondary {
    background: #6c757d;
    color: white;
}
.btn-secondary:hover {
    background: #5a6268;
}
.btn-outline {
    background: white;
    color: #007bff;
    border: 2px solid #007bff;
}
.btn-outline:hover {
    background: #007bff;
    color: white;
}
.form-group {
    margin-bottom: 1.5rem;
}
label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}
input[type="password"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}
input[type="password"]:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 0.5rem;
}
.status-badge.active {
    background: #d4edda;
    color: #155724;
}
.status-badge.none {
    background: #f8d7da;
    color: #721c24;
}
{% endblock %}

{% block content %}
<a href="/settings" class="back-link">‚Üê Back to Settings</a>

<div class="settings-header">
    <h1>Recovery Codes</h1>
</div>

<div class="settings-card">
    <div class="info-box">
        <h3>
            Status:
            {% if has_codes %}
                <span class="status-badge active">Configured</span>
            {% else %}
                <span class="status-badge none">Not Set Up</span>
            {% endif %}
        </h3>
        <p>
            Recovery codes are backup codes that let you access your account if you lose access to your email.
        </p>
    </div>

    {% if new_codes %}
        {# Just generated new codes - show them #}
        <div class="recovery-codes-display">
            <h3>‚ö†Ô∏è Save These Recovery Codes Now</h3>
            <p style="color: #666; margin-bottom: 1rem;">
                These codes will only be shown once. Save them in a secure place like a password manager.
            </p>

            <div class="codes-grid">
                {% for code in new_codes %}
                    <div class="code-item">{{ code }}</div>
                {% endfor %}
            </div>

            <div class="code-actions">
                <button onclick="copyToClipboard()" class="btn btn-outline">üìã Copy All</button>
                <button onclick="downloadCodes()" class="btn btn-outline">üíæ Download</button>
                <button onclick="window.print()" class="btn btn-outline">üñ®Ô∏è Print</button>
            </div>
        </div>

        <div class="info-box warning">
            <h3>Important</h3>
            <ul>
                <li>Each code can only be used once</li>
                <li>Store them securely - they won't be shown again</li>
                <li>Use them to sign in if you lose access to your email</li>
            </ul>
        </div>

        <script>
            const codes = {{ new_codes|tojson }};

            function copyToClipboard() {
                const text = codes.join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    alert('Recovery codes copied to clipboard!');
                });
            }

            function downloadCodes() {
                const text = codes.join('\n');
                const blob = new Blob([text], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lendifyme-recovery-codes.txt';
                a.click();
                window.URL.revokeObjectURL(url);
            }
        </script>

    {% else %}
        {# No new codes - show generation form #}

        {% if has_codes %}
            <div class="info-box">
                <h3>Your Recovery Codes Are Set</h3>
                <p>
                    You have recovery codes configured. If you've lost them, you can generate new ones below.
                    <strong>Warning:</strong> Generating new codes will invalidate all previous codes.
                </p>
            </div>

            <h2>Generate New Recovery Codes</h2>
        {% else %}
            <div class="info-box warning">
                <h3>‚ö†Ô∏è No Recovery Codes</h3>
                <p>
                    You don't have any recovery codes yet. Generate them now to ensure you can access your account
                    even if you lose access to your email.
                </p>
            </div>

            <h2>Generate Recovery Codes</h2>
        {% endif %}

        <form method="post">
            <input type="hidden" name="action" value="generate">

            {% if has_password %}
                <div class="form-group">
                    <label for="password">Confirm Your Password</label>
                    <input type="password" id="password" name="password" required>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                        Enter your password to generate new recovery codes
                    </p>
                </div>
            {% else %}
                <p style="color: #666; margin-bottom: 1.5rem;">
                    Click the button below to generate your recovery codes.
                </p>
            {% endif %}

            <button type="submit" class="btn btn-primary"
                    {% if has_codes %}
                    onclick="return confirm('This will invalidate all your existing recovery codes. Are you sure?');"
                    {% endif %}>
                {% if has_codes %}
                    Regenerate Recovery Codes
                {% else %}
                    Generate Recovery Codes
                {% endif %}
            </button>
        </form>

        <div class="info-box" style="margin-top: 2rem;">
            <h3>How Recovery Codes Work</h3>
            <ul>
                <li>Each code can only be used once to sign in</li>
                <li>You'll get 10 codes when you generate them</li>
                <li>Use them if you lose access to your email</li>
                <li>Keep them in a secure place (password manager, safe, etc.)</li>
            </ul>
        </div>
    {% endif %}
</div>
{% endblock %}
