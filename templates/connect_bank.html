{% extends "base.html" %}

{% block title %}Connect Your Bank – LendifyMe{% endblock %}

{% block extra_css %}
.bank-connection-container {
    max-width: 900px;
    margin: 0 auto;
}

.current-connection {
    background: #e7f5e7;
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.current-connection h2 {
    margin: 0 0 0.5rem 0;
    color: #28a745;
}

.bank-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.bank-card {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.bank-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.bank-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: #333;
}

.bank-card .auth-type {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 1rem;
}

.bank-card button {
    width: 100%;
    padding: 0.75rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
}

.bank-card button:hover {
    background: #0056b3;
}

.section-title {
    font-size: 1.25rem;
    font-weight: bold;
    color: #333;
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #ddd;
}

.info-box {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.info-box p {
    margin: 0 0 0.5rem 0;
    line-height: 1.6;
}

.back-link {
    display: inline-block;
    margin-bottom: 1.5rem;
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
}

.back-link:hover {
    text-decoration: underline;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
}

.modal-content h2 {
    margin-top: 0;
}

.modal-content input {
    width: 100%;
    padding: 0.75rem;
    margin: 1rem 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    box-sizing: border-box;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.modal-actions button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
}

.modal-actions .btn-primary {
    background: #007bff;
    color: white;
}

.modal-actions .btn-primary:hover {
    background: #0056b3;
}

.modal-actions .btn-secondary {
    background: #6c757d;
    color: white;
}

.modal-actions .btn-secondary:hover {
    background: #545b62;
}

.disconnect-btn {
    background: #dc3545;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.disconnect-btn:hover {
    background: #c82333;
}
{% endblock %}

{% block content %}
<div class="bank-connection-container">
    <a href="/" class="back-link">← Back to Dashboard</a>

    <h1>Connect Your Bank</h1>

    {% if current_connection %}
    <div class="current-connection">
        <h2>✓ Connected: {{ current_connection.name }}</h2>
        <p>Your bank is connected and ready to fetch transactions automatically.</p>
        <form method="POST" action="/disconnect-bank" style="margin-top: 1rem;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="disconnect-btn">Disconnect Bank</button>
        </form>
    </div>
    {% else %}
    <div class="info-box">
        <p><strong>Why connect your bank?</strong></p>
        <p>Automatically import and match repayments from your bank transactions. No more manual CSV uploads!</p>
    </div>
    {% endif %}

    {% if api_key_banks %}
    <h2 class="section-title">Banks with API Access</h2>
    <p style="color: #666; margin-bottom: 1rem;">These banks require an API key (you can get one from their website)</p>

    <div class="bank-grid">
        {% for bank in api_key_banks %}
        <div class="bank-card" data-bank-id="{{ bank.id }}" data-auth-type="{{ bank.auth_type }}">
            <h3>{{ bank.name }}</h3>
            <p class="auth-type">{{ bank.description }}</p>
            <button onclick="connectBank('{{ bank.id }}', '{{ bank.auth_type }}', '{{ bank.name }}')">
                Connect
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if oauth_banks %}
    <h2 class="section-title">Australian Banks</h2>
    <p style="color: #666; margin-bottom: 1rem;">Connect securely using your online banking login</p>

    <div class="bank-grid">
        {% for bank in oauth_banks %}
        <div class="bank-card" data-bank-id="{{ bank.id }}" data-auth-type="{{ bank.auth_type }}">
            <h3>{{ bank.name }}</h3>
            <p class="auth-type">{{ bank.description }}</p>
            <button onclick="connectBank('{{ bank.id }}', '{{ bank.auth_type }}', '{{ bank.name }}')">
                Connect
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="info-box" style="margin-top: 3rem;">
        <p><strong>Security Note:</strong></p>
        <p>Your banking credentials are never stored by LendifyMe. API keys are encrypted, and OAuth connections are handled securely by your bank.</p>
    </div>
</div>

<!-- API Key Modal -->
<div id="apiKeyModal" class="modal">
    <div class="modal-content">
        <h2>Connect <span id="modalBankName"></span></h2>
        <p>Enter your API key from <span id="modalBankName2"></span>:</p>
        <input type="text" id="apiKeyInput" placeholder="up:yeah:..." autocomplete="off">
        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
            You can get your API key from your bank's developer portal or settings page.
        </p>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="submitApiKey()">Connect</button>
        </div>
    </div>
</div>

<script>
let currentBankId = null;
let currentBankName = null;

function connectBank(bankId, authType, bankName) {
    if (authType === 'api_key') {
        // Show modal to enter API key
        currentBankId = bankId;
        currentBankName = bankName;
        document.getElementById('modalBankName').textContent = bankName;
        document.getElementById('modalBankName2').textContent = bankName;
        document.getElementById('apiKeyInput').value = '';
        document.getElementById('apiKeyModal').style.display = 'block';
    } else {
        // Open OAuth flow in popup window
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        const popup = window.open(
            '/connect-bank/' + bankId + '/oauth',
            'BankConnection',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );

        if (popup) {
            // Check if popup closed every 500ms
            const checkPopup = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkPopup);
                    // Show loading message
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998;';
                    const message = document.createElement('div');
                    message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem 3rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center; z-index: 9999;';
                    message.innerHTML = '<h3 style="margin: 0 0 1rem 0;">Verifying Connection...</h3><p style="color: #666; margin: 0 0 1.5rem 0;">Please wait while we check your bank connection status.</p><div style="border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div><style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}</style>';
                    document.body.appendChild(overlay);
                    document.body.appendChild(message);

                    // Reload page to show connection status
                    console.log('Bank connection popup closed, reloading...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }, 500);
        } else {
            alert('Please allow popups for this site to connect your bank');
        }
    }
}

function closeModal() {
    document.getElementById('apiKeyModal').style.display = 'none';
}

function submitApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();

    if (!apiKey) {
        alert('Please enter an API key');
        return;
    }

    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Connecting...';
    submitBtn.disabled = true;

    fetch('/connect-bank/api-key', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            bank_id: currentBankId,
            api_key: apiKey
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Connection failed');
            });
        }
        return response.json();
    })
    .then(data => {
        // Success! Reload page to show connected status
        alert('Successfully connected ' + data.bank_name + '!');
        window.location.reload();
    })
    .catch(error => {
        alert('Error: ' + error.message);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('apiKeyModal');
    if (event.target == modal) {
        closeModal();
    }
}

// Allow Enter key to submit
document.getElementById('apiKeyInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        submitApiKey();
    }
});
</script>
{% endblock %}
